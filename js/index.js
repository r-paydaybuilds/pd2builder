import e from"./Builder.js";import t,{UIEventHandler as i}from"./Util.js";import n from"./Language.js";window.addEventListener("resize",(()=>{const e=new URL(window.location.href);!e.pathname.endsWith("mobile.html")&&window.innerWidth<1003?(e.pathname+="mobile.html",window.location.replace(e)):e.pathname.endsWith("mobile.html")&&window.innerWidth>=1003&&(e.pathname=e.pathname.replace("mobile.html",""),window.location.replace(e))}));const o=new e(window.innerWidth<1003);window.onload=async()=>{o.lang=new n(document.getElementById("langDrop"));const l=o.lang.handleSelect(o.loadLanguage,o);if(o.mobile){document.addEventListener("click",(e=>{document.querySelector("#description_card.active")&&"BODY"!==e.target.tagName&&!e.target.closest("#description_card.active")&&o.gui.DescriptionCard_Show(!1),document.querySelector(".sk_tree_button_group.active")&&!e.target.closest("#sk_tree_buttons button, .sk_tree_button_group")&&o.gui.Tree_ShowSelection(!1)})),document.querySelector("#description_card > a").addEventListener("click",(()=>o.gui.DescriptionCard_Show(!1)));{const e=document.getElementById("description_card");let i=0,n=0,l=null,s=!1;e.addEventListener("touchstart",(e=>{if(null!==l)return;const t=e.touches.item(0);l=t.identifier,n=t.clientX,s=!0})),e.addEventListener("touchmove",(e=>{if(!s)return;e.preventDefault();const a=t.findTouch(e.changedTouches,l);a&&(i=-(a.clientX-n),i>0&&(i=0),o.gui.DescriptionCard_Analog(i))})),e.addEventListener("touchend",(n=>{s&&!t.findTouch(n.touches,l)&&(n.touches.length>0?l=n.touches.item(0).identifier:(l=null,i<=e.clientWidth/-3?o.gui.DescriptionCard_Show(!1):o.gui.DescriptionCard_Show(),s=!1))}),{passive:!0}),e.addEventListener("touchcancel",(()=>{l=null,o.gui.DescriptionCard_Show()}))}document.querySelector("#sk_tree_buttons button").addEventListener("click",(()=>o.gui.Tree_ShowSelection())),document.getElementById("sk_prev_tree").addEventListener("click",(e=>{if(e.target.classList.contains("hidden"))return;const t=[...document.querySelectorAll(".sk_tree_button_group > div")],i=t.findIndex((e=>e.classList.contains("sk_tree_button_active")));t[i-1].click()})),document.getElementById("sk_next_tree").addEventListener("click",(e=>{if(e.target.classList.contains("hidden"))return;const t=[...document.querySelectorAll(".sk_tree_button_group > div")],i=t.findIndex((e=>e.classList.contains("sk_tree_button_active")));t[i+1].click()})),o.scrollTransformer.addContext(document.getElementById("tab_page_buttons"),-1)}document.querySelectorAll("#tab_page_buttons button").forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("id").replace("_button","_page");o.gui.Tab_IsOn(t)||("tab_io_page"===t&&(document.getElementById("io_share_link").value=o.io.GetEncodedBuild()),o.gui.HandleRequirements(e.getAttribute("id").replace(/tab_|_button/g,"")),o.gui.Tab_ChangeTo(t),window.sessionStorage.setItem("curTab",t))}))}));for(const t of e.TREES)document.getElementById(`sk_${t}_button`).addEventListener("click",(e=>{o.gui.Tree_ChangeTo(e.target.id.replace("button","container")),o.mobile&&o.gui.Tree_ShowSelection(!1)}));for(const e of document.getElementsByClassName("mousewheel_scrollable"))e.addEventListener("wheel",(e=>{e.deltaY<0?o.gui.Tree_ChangeByScrolling(!1):o.gui.Tree_ChangeByScrolling(!0),e.preventDefault()}));for(const e of document.getElementsByClassName("sk_subtree"))e.addEventListener("mouseenter",(()=>{o.gui.Subtree_HoveringHighlightOn(e)})),e.addEventListener("mouseleave",(()=>{o.gui.Subtree_HoveringHighlightOff()}));for(const e of document.getElementsByClassName("sk_icon")){let n=!1;e.addEventListener("click",(i=>{if(o.mobile&&i.isTrusted)return;if(n)return n=!1,void i.stopPropagation();const l=e.firstElementChild.id;if(e.classList.contains("sk_locked")||e.classList.contains("sk_selected_aced"))o.gui.Skill_AnimateInvalid(e);else if(o.sys.Skill_Add(l)){o.gui.Skill_Add(e),"jack_of_all_trades"===l&&e.classList.contains("sk_selected_aced")&&o.gui.HandleJoat();const n=o.dbs.get("skills").get(l);o.gui.Skill_UpdatePointsRemaining(o.exp.skills.points),o.gui.Subtree_MoveBackground(n.subtree,o.exp.subtrees[n.subtree].points),(i.isTrusted||-1==i.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`added skill ${l}`,o.io.GetEncodedBuild())}else o.gui.Skill_AnimateInvalid(e)})),e.addEventListener("contextmenu",(i=>{i.preventDefault();const n=e.firstElementChild.id;if(o.sys.Skill_Remove(n)){o.gui.Skill_Remove(e),"jack_of_all_trades"!==n||e.classList.contains("sk_selected_aced")||o.gui.HandleJoat();const l=o.dbs.get("skills").get(n);o.gui.Skill_UpdatePointsRemaining(o.exp.skills.points),o.gui.Subtree_MoveBackground(l.subtree,o.exp.subtrees[l.subtree].points),o.gui.HandleUnlocks({type:"skill",id:n,unlocks:l.unlocks}),(i.isTrusted||-1==i.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`removed skill ${n}`,o.io.GetEncodedBuild())}else o.gui.Skill_AnimateInvalid(e)})),o.mobile||e.addEventListener("mouseenter",(()=>{const t=e.firstElementChild.id;document.getElementsByClassName("sk_description")[0].dataset.skill!==t&&o.gui.Skill_DisplayDescription(t)})),new i({hold:()=>{n=!0;const t=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Skill_DisplayDescription(t)},double:()=>{const t=o.exp.skills.get(e.firstElementChild.id);t?Array.from(Array(t.state)).forEach((()=>e.dispatchEvent(new MouseEvent("contextmenu",{detail:-1})))):[0,1].forEach((()=>e.click()))},element:e,mobile:o.mobile})}for(const e of document.getElementsByClassName("pk_deck")){let n=!1;e.addEventListener("click",(i=>{if(n)return i.stopPropagation(),void(n=!1);const l=e.id,s=(o.exp.perkDeck,o.exp.perkDeckUnlock);o.exp.perkDeck!==l&&(o.exp.perkDeck=l,o.perkDeckUnlockHandler(),o.gui.PerkDeck_Select(e),s&&s!=o.exp.perkDeckUnlock&&o.gui.HandleUnlocks({type:"perkDeckUnlock",id:s,unlocks:o.dbs.get("perk_decks").get(s).unlocks}),(i.isTrusted||-1==i.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used perk ${l}`,o.io.GetEncodedBuild()))})),o.mobile||e.addEventListener("mouseenter",(()=>{const t=e.id;document.getElementsByClassName("pk_description")[0].dataset.perkdeck!==t&&o.gui.PerkDeck_DisplayDescription(t)})),new i({double:()=>null,hold:()=>{n=!0;let t=e.firstElementChild.id;o.mobile&&(o.gui.DescriptionCard_Show(),t=e.id),o.gui.PerkDeck_DisplayDescription(t)},element:e,mobile:o.mobile})}for(const e of document.querySelectorAll(".pk_deck_cards .pk_has_boost"))e.addEventListener("click",(i=>{if(!e.id||!o.dbs.get("perk_cards").get(e.id).has_copycat_boost)return;o.changeCardBoost(e);const n=o.exp.perkDeckUnlock;n&&o.exp.perkDeckUnlock!=n&&o.gui.HandleUnlocks({type:"perkDeckUnlock",id:n,unlocks:o.dbs.get("perk_deck_unlocks").get(n).unlocks}),o.gui.PerkCard_DisplayDescription(e),(i.isTrusted||-1==i.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used perk boost ${e.id}`,o.io.GetEncodedBuild())}));o.mobile?(document.querySelectorAll(".pk_deck_cards").forEach((e=>o.scrollTransformer.addContext(e,-1,!1))),document.querySelectorAll(".pk_deck_cards > div").forEach((e=>{new i({click:()=>e.parentElement.parentElement.dispatchEvent(new MouseEvent("click",{detail:-1})),hold:()=>{o.gui.DescriptionCard_Show(),o.gui.PerkCard_DisplayDescription(e)},double:()=>null,mobile:!0,element:e,propagate:!0})}))):document.querySelectorAll(".pk_deck_cards > div").forEach((e=>{e.addEventListener("mouseenter",(()=>{o.gui.PerkCard_HoveringHighlightOn(e),o.gui.PerkCard_DisplayDescription(e)})),e.addEventListener("mouseleave",(()=>{o.gui.PerkCard_HoveringHighlightOff()})),new i({click:()=>e.parentElement.dispatchEvent(new MouseEvent("click",{detail:-1})),hold:()=>{o.gui.PerkCard_DisplayDescription(e)},double:()=>null,mobile:!1,element:e})}));for(const e of document.getElementsByClassName("arm_icon")){let n=!1;e.addEventListener("click",(i=>{if(n)return n=!1,void i.stopPropagation();const l=e.firstElementChild.id;o.exp.armor===l||e.classList.contains("arm_locked")||(o.exp.armor=l,o.stats.setBaseStats(o.dbs.get("armors").get(l).stats),o.gui.Armor_Select(e),o.gui.Armor_DisplayDescriptionCard(l),(i.isTrusted||-1==i.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used armor ${l}`,o.io.GetEncodedBuild()))})),o.mobile||e.addEventListener("mouseenter",(()=>{o.gui.Armor_DisplayDescriptionCard(e.firstElementChild.id)})),new i({hold:()=>{n=!0;const t=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Armor_DisplayDescriptionCard(t)},double:()=>null,element:e,mobile:o.mobile})}for(const e of document.getElementsByClassName("th_icon")){let n=!1;e.addEventListener("click",(i=>{if(n)return i.stopPropagation(),void(n=!1);const l=e.firstElementChild.id;o.exp.throwable===l||e.classList.contains("th_locked")||(o.exp.throwable=l,o.gui.Throwable_Select(e),(i.isTrusted||-1==i.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used throwable ${l}`,o.io.GetEncodedBuild()))})),o.mobile||e.addEventListener("mouseenter",(()=>o.gui.Throwable_DisplayDescriptionCard(e.firstElementChild.id))),new i({hold:()=>{n=!0;const t=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Throwable_DisplayDescriptionCard(t)},double:()=>null,element:e,mobile:o.mobile})}for(const e of document.getElementsByClassName("dp_icon")){let n=!1;e.addEventListener("click",(i=>{if(n)return i.stopPropagation(),void(n=!1);const l=e.firstElementChild.id;o.exp.deployable===l||e.classList.contains("dp_locked")||(o.exp.deployableSecondary===l&&(o.exp.deployableSecondary=null,o.gui.DeployableSecondary_Unselect()),o.exp.deployable=l,o.gui.Deployable_Select(e),(i.isTrusted||-1==i.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used perk ${l}`,o.io.GetEncodedBuild()))})),e.addEventListener("contextmenu",(i=>{i.preventDefault();const n=o.exp.skills.get("jack_of_all_trades"),l=e.firstElementChild.id;n&&2==n.state&&o.exp.deployable!==l?(o.exp.deployableSecondary=l,o.gui.Deployable_SelectSecondary(e),(i.isTrusted||-1==i.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used perk ${l}`,o.io.GetEncodedBuild())):e.dispatchEvent(new MouseEvent("click",{detail:-1}))})),o.mobile||e.addEventListener("mouseenter",(()=>o.gui.Deployable_DisplayDescriptionCard(e.firstElementChild.id))),new i({hold:()=>{n=!0;const t=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Deployable_DisplayDescriptionCard(t)},element:e,mobile:o.mobile})}document.getElementById("io_copy_btn").addEventListener("click",(()=>{const e=document.getElementById("io_share_link");e.select(),document.execCommand("copy"),e.blur(),o.gui.IO_CopyLinkFlash()}));{const e=document.getElementById("io_share_button");"share"in navigator?e.addEventListener("click",(()=>navigator.share({title:"PD2Builder",text:"Check out this build!",url:o.io.GetEncodedBuild()}))):e.style.display="none"}window.onpopstate=async e=>{if(e.state)for(const[t,i]of Object.entries(e.state))switch(t){case"lang":localStorage.setItem("lang",i),document.getElementById("langDrop").value=i,o.lang.loadDictionary(await fetch(`./lang/${i}.json`).then((e=>e.json()))),o.lang.used=i,o.loadLanguage(i);break;case"tab":sessionStorage.setItem("curTab",i),o.gui.Tab_ChangeTo(i);break;case"skills":for(const[e,t]of[...o.exp.skills].reverse()){const n=i[e],o=document.getElementById(e).parentElement;if(n)t.state>n.state?o.dispatchEvent(new MouseEvent("contextmenu")):t.state<n.state&&o.click();else for(let e=t.state;e>0;e--)o.dispatchEvent(new MouseEvent("contextmenu"));delete i[e]}for(const[e,t]of Object.entries(i))for(let i=0;i<t.state;i++)document.getElementById(e).parentElement.click();break;case"perkDeck":if(!i){o.exp.perkDeck=null,o.gui.PerkDeck_Unselect(),o.gui.PerkCard_HoveringHighlightOff();break}document.getElementById(i).click();break;case"armor":if(!i){o.exp.armor=null,o.gui.Armor_Unselect();break}case"throwable":if(!i){o.exp.throwable=null,o.gui.Throwable_Unselect();break}case"deployable":if(!i){o.exp.deployable=null;const e=document.querySelector(".dp_primary, .dp_selected");e&&o.gui.Deployable_Unselect(e);break}document.getElementById(i).parentElement.click();break;case"deployableSecondary":if(!i){o.exp.deployableSecondary=null;const e=document.querySelector(".dp_secondary");e&&o.gui.Deployable_Unselect(e);break}document.getElementById(i).parentElement.dispatchEvent(new MouseEvent("contextmenu"))}},await o.fetchPromises,o.lang.loadDictionary(await l),o.loadLanguage(o.lang.curLang),"serviceWorker"in navigator&&"9999"!==location.port&&navigator.serviceWorker.register("./sw.js").then((e=>{e.onupdatefound=()=>{const t=e.installing;t.onstatechange=()=>{"installed"===t.state&&navigator.serviceWorker.controller&&window.confirm(o.lang.get("system.update"))&&location.reload()}}})),o.gui.Tab_ChangeTo("tab_skills_page"),o.gui.Skill_UpdatePointsRemaining(o.exp.skills.points),o.gui.Tree_ChangeTo("sk_mastermind_container"),o.io.HasToLoadBuild()&&o.io.LoadBuildFromIterable(new URLSearchParams(window.location.search));{let e=window.sessionStorage.getItem("curTab")||"tab_skills_page";null==document.getElementById(e)&&(e="tab_skills_page"),o.gui.HandleRequirements(e.replace(/tab_|_page/g,"")),o.gui.Tab_ChangeTo(e),window.history.replaceState(t.makeState(o.lang.used,o.exp,e),"PD2 Builder")}o.gui.LoadingSpinner_Display(!1)},window.builder=o;
