import e from"./Builder.js";import t,{UIEventHandler as n}from"./Util.js";import i from"./Language.js";window.addEventListener("resize",(()=>{const e=new URL(window.location.href);!e.pathname.endsWith("mobile.html")&&window.innerWidth<1003?(e.pathname+="mobile.html",window.location.replace(e)):e.pathname.endsWith("mobile.html")&&window.innerWidth>=1003&&(e.pathname=e.pathname.replace("mobile.html",""),window.location.replace(e))}));const o=new e(window.innerWidth<1003);window.onload=async()=>{o.lang=new i(document.getElementById("langDrop"));const l=o.lang.handleSelect(o.loadLanguage,o);if(o.mobile){document.addEventListener("click",(e=>{document.querySelector("#description_card.active")&&"BODY"!==e.target.tagName&&!e.target.closest("#description_card.active")&&o.gui.DescriptionCard_Show(!1),document.querySelector(".sk_tree_button_group.active")&&!e.target.closest("#sk_tree_buttons button, .sk_tree_button_group")&&o.gui.Tree_ShowSelection(!1)})),document.querySelector("#description_card > a").addEventListener("click",(()=>o.gui.DescriptionCard_Show(!1)));{const e=document.getElementById("description_card");let n=0,i=0,l=null,a=!1;e.addEventListener("touchstart",(e=>{if(null!==l)return;const t=e.touches.item(0);l=t.identifier,i=t.clientX,a=!0})),e.addEventListener("touchmove",(e=>{if(!a)return;e.preventDefault();const s=t.findTouch(e.changedTouches,l);s&&(n=-(s.clientX-i),n>0&&(n=0),o.gui.DescriptionCard_Analog(n))})),e.addEventListener("touchend",(i=>{a&&!t.findTouch(i.touches,l)&&(i.touches.length>0?l=i.touches.item(0).identifier:(l=null,n<=e.clientWidth/-3?o.gui.DescriptionCard_Show(!1):o.gui.DescriptionCard_Show(),a=!1))}),{passive:!0}),e.addEventListener("touchcancel",(()=>{l=null,o.gui.DescriptionCard_Show()}))}document.querySelector("#sk_tree_buttons button").addEventListener("click",(()=>o.gui.Tree_ShowSelection())),document.getElementById("sk_prev_tree").addEventListener("click",(e=>{if(e.target.classList.contains("hidden"))return;const t=[...document.querySelectorAll(".sk_tree_button_group > div")],n=t.findIndex((e=>e.classList.contains("sk_tree_button_active")));t[n-1].click()})),document.getElementById("sk_next_tree").addEventListener("click",(e=>{if(e.target.classList.contains("hidden"))return;const t=[...document.querySelectorAll(".sk_tree_button_group > div")],n=t.findIndex((e=>e.classList.contains("sk_tree_button_active")));t[n+1].click()})),o.scrollTransformer.addContext(document.getElementById("tab_page_buttons"),-1)}document.getElementById("chk_disable_infamy").addEventListener("change",(e=>{o.exp.infamyDisabled=e.target.checked,o.sys.Validate_Skills(),(e.isTrusted||-1==e.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`disable infamy checkbox changed to ${e.target.checked}`,o.io.GetEncodedBuild())})),document.querySelectorAll("#tab_page_buttons button").forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("id").replace("_button","_page");o.gui.Tab_IsOn(t)||("tab_io_page"===t&&(document.getElementById("io_share_link").value=o.io.GetEncodedBuild()),o.gui.HandleRequirements(e.getAttribute("id").replace(/tab_|_button/g,"")),o.gui.Tab_ChangeTo(t),window.sessionStorage.setItem("curTab",t))}))}));for(const t of e.TREES)document.getElementById(`sk_${t}_button`).addEventListener("click",(e=>{o.gui.Tree_ChangeTo(e.target.id.replace("button","container")),o.mobile&&o.gui.Tree_ShowSelection(!1)}));for(const e of document.getElementsByClassName("mousewheel_scrollable"))e.addEventListener("wheel",(e=>{e.deltaY<0?o.gui.Tree_ChangeByScrolling(!1):o.gui.Tree_ChangeByScrolling(!0),e.preventDefault()}));for(const e of document.getElementsByClassName("sk_subtree"))e.addEventListener("mouseenter",(()=>{o.gui.Subtree_HoveringHighlightOn(e)})),e.addEventListener("mouseleave",(()=>{o.gui.Subtree_HoveringHighlightOff()}));for(const e of document.getElementsByClassName("sk_icon")){let i=!1;e.addEventListener("click",(n=>{if(o.mobile&&n.isTrusted)return;if(i)return i=!1,void n.stopPropagation();const l=e.firstElementChild.id;if(e.classList.contains("sk_locked")||e.classList.contains("sk_selected_aced"))o.gui.Skill_AnimateInvalid(e);else if(o.sys.Skill_Add(l)){switch(o.gui.Skill_Add(e),l){case"iron_man":e.classList.contains("sk_selected_aced")&&(o.exp.armor="ictv",o.gui.Armor_SelectById("ictv"));break;case"jack_of_all_trades":e.classList.contains("sk_selected_aced")&&o.gui.HandleJoat()}const i=o.dbs.get("skills").get(l);o.gui.Skill_UpdatePointsRemaining(o.exp.skills.points),o.gui.Subtree_MoveBackground(i.subtree,o.exp.subtrees[i.subtree].points),(n.isTrusted||-1==n.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`added skill ${l}`,o.io.GetEncodedBuild())}else o.gui.Skill_AnimateInvalid(e)})),e.addEventListener("contextmenu",(n=>{n.preventDefault();const i=e.firstElementChild.id;if(o.sys.Skill_Remove(i)){switch(i){case"iron_man":e.classList.contains("sk_selected_aced")&&"ictv"===o.exp.armor&&(o.gui.Armor_Unselect(),o.exp.armor=null);break;case"engineering":if(e.classList.contains("sk_selected_basic"))if("suppressed_sentry_gun"===o.exp.deployableSecondary)o.exp.deployableSecondary=null,o.gui.DeployableSecondary_Unselect();else if("suppressed_sentry_gun"===o.exp.deployable)if(null!==o.exp.deployableSecondary){const e=document.querySelector(".dp_secondary");o.gui.DeployableSecondary_Unselect(),o.exp.deployable=o.exp.deployableSecondary,o.exp.deployableSecondary=null,o.gui.Deployable_Select(e)}else o.exp.deployable=null,o.gui.Deployable_Unselect(document.querySelector(".dp_primary, .dp_selected"));break;case"jack_of_all_trades":e.classList.contains("sk_selected_aced")&&(o.gui.HandleJoat(!0),o.exp.deployableSecondary=null,o.gui.DeployableSecondary_Unselect())}o.gui.Skill_Remove(e);const l=o.dbs.get("skills").get(i);o.gui.Skill_UpdatePointsRemaining(o.exp.skills.points),o.gui.Subtree_MoveBackground(l.subtree,o.exp.subtrees[l.subtree].points),o.gui.HandleUnlocks({type:"skill",id:i,unlocks:l.unlocks}),(n.isTrusted||-1==n.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`removed skill ${i}`,o.io.GetEncodedBuild())}else o.gui.Skill_AnimateInvalid(e)})),o.mobile||e.addEventListener("mouseenter",(()=>{const t=e.firstElementChild.id;document.getElementsByClassName("sk_description")[0].dataset.skill!==t&&o.gui.Skill_DisplayDescription(t)})),new n({hold:()=>{i=!0;const t=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Skill_DisplayDescription(t)},double:()=>{const t=o.exp.skills.get(e.firstElementChild.id);t?Array.from(Array(t.state)).forEach((()=>e.dispatchEvent(new MouseEvent("contextmenu",{detail:-1})))):[0,1].forEach((()=>e.click()))},element:e,mobile:o.mobile})}for(const e of document.getElementsByClassName("pk_deck")){let i=!1;e.addEventListener("click",(n=>{if(i)return n.stopPropagation(),void(i=!1);const l=e.id,a=o.exp.perkDeckUnlock;o.exp.perkDeck!==l&&(o.exp.perkDeck=l,o.perkDeckUnlockHandler(),o.gui.PerkDeck_Select(e),a&&a!=o.exp.perkDeckUnlock&&o.gui.HandleUnlocks({type:"perkDeckUnlock",id:a,unlocks:o.dbs.get("perk_decks").get(a).unlocks}),(n.isTrusted||-1==n.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used perk ${l}`,o.io.GetEncodedBuild()))})),o.mobile||e.addEventListener("mouseenter",(()=>{const t=e.id;document.getElementsByClassName("pk_description")[0].dataset.perkdeck!==t&&o.gui.PerkDeck_DisplayDescription(t)})),new n({double:()=>null,hold:()=>{i=!0;let t=e.firstElementChild.id;o.mobile&&(o.gui.DescriptionCard_Show(),t=e.id),o.gui.PerkDeck_DisplayDescription(t)},element:e,mobile:o.mobile})}for(const e of document.querySelectorAll(".pk_deck_cards .pk_has_boost"))e.addEventListener("click",(n=>{if(!e.id||!o.dbs.get("perk_cards").get(e.id).has_copycat_boost||0!=n.button)return;const i=o.exp.perkDeckUnlock;o.changeCardBoost(e),i&&o.exp.perkDeckUnlock!=i&&o.gui.HandleUnlocks({type:"perkDeckUnlock",id:i,unlocks:o.dbs.get("perk_decks").get(i).unlocks}),o.gui.PerkCard_DisplayDescription(e),(n.isTrusted||-1==n.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used perk boost ${e.id}`,o.io.GetEncodedBuild())})),e.addEventListener("contextmenu",(n=>{if(n.preventDefault(),!e.id||!o.dbs.get("perk_cards").get(e.id).has_copycat_boost||2!=n.button)return;const i=o.exp.perkDeckUnlock;o.changeCardBoost(e,-1),i&&o.exp.perkDeckUnlock!=i&&o.gui.HandleUnlocks({type:"perkDeckUnlock",id:i,unlocks:o.dbs.get("perk_decks").get(i).unlocks}),o.gui.PerkCard_DisplayDescription(e),(n.isTrusted||-1==n.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used perk boost ${e.id}`,o.io.GetEncodedBuild())}));o.mobile?(document.querySelectorAll(".pk_deck_cards").forEach((e=>o.scrollTransformer.addContext(e,-1,!1))),document.querySelectorAll(".pk_deck_cards > div").forEach((e=>{new n({click:()=>e.parentElement.parentElement.dispatchEvent(new MouseEvent("click",{detail:-1})),hold:()=>{o.gui.DescriptionCard_Show(),o.gui.PerkCard_DisplayDescription(e)},double:()=>null,mobile:!0,element:e,propagate:!0})}))):document.querySelectorAll(".pk_deck_cards > div").forEach((e=>{e.addEventListener("mouseenter",(()=>{o.gui.PerkCard_HoveringHighlightOn(e),o.gui.PerkCard_DisplayDescription(e)})),e.addEventListener("mouseleave",(()=>{o.gui.PerkCard_HoveringHighlightOff()})),new n({click:()=>e.parentElement.dispatchEvent(new MouseEvent("click",{detail:-1})),hold:()=>{o.gui.PerkCard_DisplayDescription(e)},double:()=>null,mobile:!1,element:e})}));for(const e of document.getElementsByClassName("arm_icon")){let i=!1;e.addEventListener("click",(n=>{if(i)return i=!1,void n.stopPropagation();const l=e.firstElementChild.id;o.exp.armor===l||e.classList.contains("arm_locked")||(o.exp.armor=l,o.stats.setBaseStats(o.dbs.get("armors").get(l).stats),o.gui.Armor_Select(e),o.gui.Armor_DisplayDescriptionCard(l),(n.isTrusted||-1==n.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used armor ${l}`,o.io.GetEncodedBuild()))})),o.mobile||e.addEventListener("mouseenter",(()=>{o.gui.Armor_DisplayDescriptionCard(e.firstElementChild.id)})),new n({hold:()=>{i=!0;const t=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Armor_DisplayDescriptionCard(t)},double:()=>null,element:e,mobile:o.mobile})}for(const e of document.getElementsByClassName("th_icon")){let i=!1;e.addEventListener("click",(n=>{if(i)return n.stopPropagation(),void(i=!1);const l=e.firstElementChild.id;o.exp.throwable===l||e.classList.contains("th_locked")||(o.exp.throwable=l,o.gui.Throwable_Select(e),(n.isTrusted||-1==n.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used throwable ${l}`,o.io.GetEncodedBuild()))})),o.mobile||e.addEventListener("mouseenter",(()=>o.gui.Throwable_DisplayDescriptionCard(e.firstElementChild.id))),new n({hold:()=>{i=!0;const t=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Throwable_DisplayDescriptionCard(t)},double:()=>null,element:e,mobile:o.mobile})}for(const e of document.getElementsByClassName("dp_icon")){let i=!1;e.addEventListener("click",(n=>{if(i)return n.stopPropagation(),void(i=!1);const l=e.firstElementChild.id;o.exp.deployable===l||e.classList.contains("dp_locked")||(o.exp.deployableSecondary===l&&(o.exp.deployableSecondary=null,o.gui.DeployableSecondary_Unselect()),o.exp.deployable=l,o.gui.Deployable_Select(e),(n.isTrusted||-1==n.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used perk ${l}`,o.io.GetEncodedBuild()))})),e.addEventListener("contextmenu",(n=>{n.preventDefault();const i=o.exp.skills.get("jack_of_all_trades"),l=e.firstElementChild.id;i&&2==i.state&&o.exp.deployable!==l?(o.exp.deployableSecondary=l,o.gui.Deployable_SelectSecondary(e),(n.isTrusted||-1==n.detail)&&window.history.pushState(t.makeState(null,o.exp,o.gui.Tab_Current),`used perk ${l}`,o.io.GetEncodedBuild())):e.dispatchEvent(new MouseEvent("click",{detail:-1}))})),o.mobile||e.addEventListener("mouseenter",(()=>o.gui.Deployable_DisplayDescriptionCard(e.firstElementChild.id))),new n({hold:()=>{i=!0;const t=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Deployable_DisplayDescriptionCard(t)},element:e,mobile:o.mobile})}document.getElementById("io_copy_btn").addEventListener("click",(()=>{const e=document.getElementById("io_share_link");e.select(),navigator.clipboard.writeText(e.value),e.blur(),o.gui.IO_CopyLinkFlash()}));{const e=document.getElementById("io_share_button");"share"in navigator?e.addEventListener("click",(()=>navigator.share({title:"PD2Builder",text:"Check out this build!",url:o.io.GetEncodedBuild()}))):e.style.display="none"}window.onpopstate=async e=>{if(e.state)for(const[t,n]of Object.entries(e.state))switch(t){case"lang":localStorage.setItem("lang",n),document.getElementById("langDrop").value=n,o.lang.loadDictionary(await fetch(`./lang/${n}.json`).then((e=>e.json()))),o.lang.used=n,o.loadLanguage(n);break;case"tab":sessionStorage.setItem("curTab",n),o.gui.Tab_ChangeTo(n);break;case"skills":for(const[e,t]of[...o.exp.skills].reverse()){const i=n[e],o=document.getElementById(e).parentElement;if(i)t.state>i.state?o.dispatchEvent(new MouseEvent("contextmenu")):t.state<i.state&&o.click();else for(let e=t.state;e>0;e--)o.dispatchEvent(new MouseEvent("contextmenu"));delete n[e]}for(const[e,t]of Object.entries(n))for(let n=0;n<t.state;n++)document.getElementById(e).parentElement.click();break;case"perkDeck":if(!n){o.exp.perkDeck=null,o.gui.PerkDeck_Unselect(),o.gui.PerkCard_HoveringHighlightOff();break}document.getElementById(n).click();break;case"armor":if(!n){o.exp.armor=null,o.gui.Armor_Unselect();break}case"throwable":if(!n){o.exp.throwable=null,o.gui.Throwable_Unselect();break}case"deployable":if(!n){o.exp.deployable=null;const e=document.querySelector(".dp_primary, .dp_selected");e&&o.gui.Deployable_Unselect(e);break}document.getElementById(n).parentElement.click();break;case"deployableSecondary":if(!n){o.exp.deployableSecondary=null;const e=document.querySelector(".dp_secondary");e&&o.gui.Deployable_Unselect(e);break}document.getElementById(n).parentElement.dispatchEvent(new MouseEvent("contextmenu"))}},await o.fetchPromises,o.lang.loadDictionary(await l),o.loadLanguage(o.lang.curLang),"serviceWorker"in navigator&&"9999"!==location.port&&navigator.serviceWorker.register("./sw.js").then((e=>{e.onupdatefound=()=>{const t=e.installing;t.onstatechange=()=>{"installed"===t.state&&navigator.serviceWorker.controller&&window.confirm(o.lang.get("system.update"))&&location.reload()}}})),o.gui.Tab_ChangeTo("tab_skills_page"),o.gui.Skill_UpdatePointsRemaining(o.exp.skills.points),o.gui.Tree_ChangeTo("sk_mastermind_container"),o.io.HasToLoadBuild()&&o.io.LoadBuildFromIterable(new URLSearchParams(window.location.search));{let e=window.sessionStorage.getItem("curTab")||"tab_skills_page";null==document.getElementById(e)&&(e="tab_skills_page"),o.gui.HandleRequirements(e.replace(/tab_|_page/g,"")),o.gui.Tab_ChangeTo(e),window.history.replaceState(t.makeState(o.lang.used,o.exp,e),"PD2 Builder")}o.gui.LoadingSpinner_Display(!1)},window.builder=o;
