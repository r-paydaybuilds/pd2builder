import e from"./Util.js";import t from"./PaydayTable.js";export default class s{constructor(e){this.builder=e}Title_ChangeTo(e){document.title=e||"Payday 2 Builder"}LoadingSpinner_Display(e){document.getElementById("loading_spinner").style.display=e?"":"none"}Tab_ChangeTo(e){const t=e.replace("_page","_button");document.querySelectorAll("#tab_page_buttons button").forEach((e=>{e.classList.remove("tab_selected")})),document.getElementById(t).classList.add("tab_selected");for(const{style:e}of document.getElementsByClassName("tab_page_content"))e.display="none";document.getElementById(e).style.display=""}Tab_IsOn(e){return null!==document.getElementById(e).offsetParent}get Tab_Current(){return document.querySelector(".tab_selected").id.replace("_button","_page")}DescriptionCard_Show(e=!0){const t=document.getElementById("description_card");t.style.cssText="",e?t.classList.add("active"):t.classList.remove("active")}DescriptionCard_Analog(e){document.getElementById("description_card").style.cssText=`right: ${e}px; transition-duration: 0ms`}Tree_ChangeTo(e){const t=e.split("_")[1],s=document.querySelector("#description_container, .sk_description");s.dataset.skill="none",s.innerHTML="",document.querySelectorAll(".sk_tree_button_active").forEach((e=>{e.classList.remove("sk_tree_button_active")})),document.getElementById(`sk_${t}_button`).classList.add("sk_tree_button_active"),document.querySelectorAll("#sk_container_r > .sk_tree").forEach((e=>{e.style.display="none"})),document.getElementById(e).style.display="";const r=[];if(document.querySelectorAll(`#${e} > .sk_subtree`).forEach((e=>{r.push(e.dataset.name)})),this.builder.mobile){document.getElementById("sk_tree_buttons").dataset.tree=t,document.querySelector("#sk_tree_buttons button").textContent=this.builder.lang.get(`system.skills.${t}.title`);const e=[...document.querySelectorAll(".sk_tree_button_group > div")],s=e.findIndex((e=>e.classList.contains("sk_tree_button_active")));0==s?(this.Tree_PrevOpacity(!1),this.Tree_NextOpacity()):s==e.length-1?(this.Tree_NextOpacity(!1),this.Tree_PrevOpacity()):(this.Tree_NextOpacity(),this.Tree_PrevOpacity())}else document.querySelector("#sk_subtree_name_left p").innerHTML=this.builder.lang.get(`system.skills.${t}.subtrees.${r[0]}`),document.querySelector("#sk_subtree_name_center p").innerHTML=this.builder.lang.get(`system.skills.${t}.subtrees.${r[1]}`),document.querySelector("#sk_subtree_name_right p").innerHTML=this.builder.lang.get(`system.skills.${t}.subtrees.${r[2]}`)}Tree_ChangeByScrolling(e){const t=[...document.getElementsByClassName("sk_tree")],s=document.getElementsByClassName("sk_tree_button_active")[0].getAttribute("id").replace("button","container");for(const r of t){if(r.getAttribute("id")!==s)continue;const i=t.indexOf(r);let l="";if(e){if(i===t.length-1)return;l=t[i+1].getAttribute("id")}else{if(0===i)return;l=t[i-1].getAttribute("id")}this.Tree_ChangeTo(l)}}Tree_ShowSelection(e=!0){const{classList:t}=document.querySelector(".sk_tree_button_group");e?t.add("active"):t.remove("active")}Tree_NextOpacity(e=!0){const{classList:t}=document.getElementById("sk_next_tree");e?t.remove("hidden"):t.add("hidden")}Tree_PrevOpacity(e=!0){const{classList:t}=document.getElementById("sk_prev_tree");e?t.remove("hidden"):t.add("hidden")}Subtree_MoveBackground(e,t){const s=document.getElementById(`sk_${e}_subtree`);let r=0,i=t;for(const[t,s]of this.builder.getSkillTierCosts().entries())s<=i?(i-=s,r+=25,this.Tier_Unlock(e,t+1)):(r+=i/s*25,this.Tier_Lock(e,t+1));s.style.backgroundSize=this.builder.mobile?`${Math.round(r)}% 100%`:`100% ${Math.round(r)}%`}Subtree_HoveringHighlightOn(e){if(!e)return;const t=e.getAttribute("id").split("_")[1].toUpperCase();e.classList.add("sk_subtree_highlight");for(const e of document.getElementsByClassName("sk_subtree_name"))e.firstElementChild.innerHTML===t&&e.classList.add("sk_subtree_name_highlight")}Subtree_HoveringHighlightOff(){document.querySelectorAll(".sk_subtree.sk_subtree_highlight").forEach((e=>{e.classList.remove("sk_subtree_highlight")})),document.querySelectorAll(".sk_subtree_name.sk_subtree_name_highlight").forEach((e=>{e.classList.remove("sk_subtree_name_highlight")}))}Tier_Lock(e,t){document.querySelectorAll(`#sk_${e}_subtree > .sk_tier[data-tier='${t}'] > div > .sk_icon:not(.sk_locked)`).forEach((e=>{e.classList.add("sk_locked"),this.Skill_Remove(e,!0)}))}Tier_Unlock(e,t){document.querySelectorAll(`#sk_${e}_subtree > .sk_tier[data-tier='${t}'] > div > .sk_icon.sk_locked`).forEach((e=>e.classList.remove("sk_locked")))}Skill_UpdatePointsRemaining(e){document.querySelector(".sk_points_remaining p span").innerHTML=e,0===e?this.Skill_ColorizePointsRemaining("#FF4751"):this.Skill_ColorizePointsRemaining()}Skill_ColorizePointsRemaining(e="#f0f0f0"){document.getElementsByClassName("sk_points_remaining")[0].style.color=e}Skill_DisplayDescription(e){const t=document.querySelector("#description_container, .sk_description"),s=this.builder.lang.get(`skills.${e}`);let r=`<p class="description_title">${s.name.toUpperCase()}</p><p>${s.description.replace(/\n/g,"</p><p>").replace(/\t/g,"<br>").replace(this.constructor.COLOR_PATTERN,(e=>`<span class="color_number">${e}</span>`))}</p>`;t.innerHTML=r,t.dataset.skill=e}Skill_Add({classList:e}){e.contains("sk_selected_basic")?(e.remove("sk_selected_basic"),e.add("sk_selected_aced")):e.add("sk_selected_basic")}Skill_Remove({classList:e},t=!1){e.contains("sk_selected_aced")?(e.remove("sk_selected_aced"),t||e.add("sk_selected_basic")):e.contains("sk_selected_basic")&&e.remove("sk_selected_basic")}Skill_AnimateInvalid({classList:e}){e.contains("sk_invalid")||("vibrate"in navigator&&navigator.vibrate(75),e.add("sk_invalid"),setTimeout((()=>{e.remove("sk_invalid")}),400))}PerkDeck_Select(e){this.PerkDeck_Unselect();const t=e.querySelector("p");e.classList.add("pk_selected"),t.innerHTML=`${this.builder.lang.get("system.equipped")}: ${t.innerHTML}`,document.querySelectorAll(".pk_deck:not(.pk_deck_dim)").forEach((e=>e.classList.add("pk_deck_dim"))),e.classList.remove("pk_deck_dim")}PerkDeck_Unselect(){const[e]=document.getElementsByClassName("pk_selected");e&&(e.querySelector("p").innerHTML=e.querySelector("p").innerHTML.replace(`${this.builder.lang.get("system.equipped")}: `,""),e.classList.remove("pk_selected"),document.querySelectorAll(".pk_deck.pk_deck_dim").forEach((e=>e.classList.remove("pk_deck_dim"))))}PerkDeck_DisplayDescription(e){const t=document.querySelector("#description_container, .pk_description"),s=this.builder.lang.get(`perk_decks.${e}`);t.innerHTML=`<p class="description_title">${s.name.toUpperCase()}</p><p>${s.description.replace(/\n/g,"</p><p>").replace(/\t/g,"<br>")}</p>`,t.dataset.perkDeck=e}PerkCard_DisplayDescription(t){if(!t)return;const s=document.querySelector("#description_container, .pk_description"),r=this.builder.dbs.get("perk_decks").get(e.parentElement(t,this.builder.mobile?3:2).id),i=this.builder.lang.get(`perk_cards.${r.perks[e.getNodeIndex(t,(e=>e instanceof Element&&"DIV"===e.tagName))]}`,this.builder.dbs.get("perk_cards").get(t.id));let l=`<p class="description_title">${i.name.toUpperCase()}`;if(l+=`</p><p>${i.description}</p>`.replace(/\n/g,"</p><p>").replace(/\t/g,"<br>").replace(this.constructor.COLOR_PATTERN,(e=>`<span class="color_number">${e}</span>`)),s.innerHTML=l,!t.id||!this.builder.dbs.get("perk_cards").get(t.id).has_copycat_boost)return;const n=(this.builder.dbs.get("perk_cards").get(t.id).has_mimicry_boost?[...this.builder.dbs.get("copycat_mimicry").entries()]:[...this.builder.dbs.get("copycat_boosts").entries()])[t.querySelector(".copycat_current_num").innerText-1][1];s.innerHTML+=`<br><p class="description_title">${n.name.toUpperCase()}<span class="description_title_sub"> (boost)</span></p>`,s.innerHTML+=`<p>${n.copycat_description?n.copycat_description:n.description}</p>`.replace(/\n/g,"</p><p>").replace(/\t/g,"<br>").replace(this.constructor.COLOR_PATTERN,(e=>`<span class="color_number">${e}</span>`))}PerkCard_HoveringHighlightOn(t){if(t){for(const s of t.parentElement.children)e.getNodeIndex(t)!==e.getNodeIndex(s)&&s.classList.add("pk_card_dim");t.classList.remove("pk_card_dim")}}PerkCard_HoveringHighlightOff(){document.querySelectorAll(".pk_card_dim").forEach((e=>e.classList.remove("pk_card_dim")))}Armor_Select({classList:e}){this.Armor_Unselect(),e.add("arm_selected")}Armor_SelectById(e){this.Armor_Select(document.getElementById(e).parentElement)}Armor_Unselect(){const e=document.querySelector(".arm_selected");e&&e.classList.remove("arm_selected")}Armor_Unlock({classList:e}){e.remove("arm_locked")}Armor_Lock({classList:e}){e.add("arm_locked")}Armor_DisplayDescriptionCard(s){const r=document.querySelector("#description_container, .arm_description"),i=this.builder.dbs.get("armors").get(s),l=this.builder.dbs.get("armors").get(this.builder.exp.armor),n=this.builder.lang.get("system.armors.table"),c=Object.entries(i.stats);let o=`<p class="description_title">${this.builder.lang.get(`armors.${s}`).toUpperCase()}`;if(l)if(s===this.builder.exp.armor){const e=this.builder.stats.getStats(...c),s=[];for(let t=0;t<e.length;t++){const r=e[t];s.push([r[0],r[1]-c[t][1]])}o+=`<br><span>${this.builder.lang.get("system.equipped")}</span></p>`+new t(["total","base","skill"],Object.keys(i.stats),{tableClass:"armor_details"}).addRows("base",c).addRows("total",e.map((e=>[e[0],e[1].maybeRound(1)]))).addRows("skill",s.map((e=>[e[0],e[1].maybeRound(1)]))).translate(n).toHTML()}else o+="</p>"+new t(["equipped","selected"],Object.keys(i.stats),{tableClass:"armor_compare"}).addRows("equipped",Object.entries(l.stats)).addRows("selected",c).compare("equipped","selected").translate(n).toHTML();else o+="</p>"+new t(["selected"],Object.keys(i.stats),{tableClass:"armor_not_chosen"}).addRows("selected",c).translate(n).toHTML();if(document.getElementById(s).parentElement.classList.contains("arm_locked"))for(const t of i.requires)o+='<br><span class="requires">'+e.resolveRequire(t.type,this.builder.lang.get(`${t.type}s.${t.name}.name`),this.builder.lang)+"</span>";r.innerHTML=o}Throwable_Select({classList:e}){this.Throwable_Unselect(),e.add("th_selected")}Throwable_SelectById(e){this.Throwable_Select(document.getElementById(e).parentElement)}Throwable_Unselect(){const e=document.querySelector(".th_selected");e&&e.classList.remove("th_selected")}Throwable_Unlock({classList:e}){e.remove("th_locked")}Throwable_Lock({classList:e}){e.add("th_locked")}Throwable_DisplayDescriptionCard(t){const s=document.querySelector("#description_container, .th_description"),r=this.builder.dbs.get("throwables").get(t);let i=this.builder.lang.get("throwables."+t);i||(i=r);let l=`<p class="description_title">${i.name}`;if(document.getElementById(t).parentElement.classList.contains("th_locked"))for(const t of r.requires){const s="perk_deck_unlock"===t.type?"perk_deck":t.type;l+='<br><span class="requires">'+e.resolveRequire(s,this.builder.lang.get(`${s}s.${t.name}.name`),this.builder.lang)+"</span>"}l+=`</p><p>${i.description}</p>`.replace(/\n/g,"</p><p>").replace(/\t/g,"<br>"),s.innerHTML=l}Deployable_Select({classList:e}){const t=document.querySelector(".dp_primary, .dp_selected");t&&this.Deployable_Unselect(t),document.getElementById("jack_of_all_trades").parentElement.classList.contains("sk_selected_aced")?e.add("dp_primary"):e.add("dp_selected")}Deployable_Unselect({classList:e}){e.remove("dp_primary","dp_selected","dp_secondary")}DeployableSecondary_Unselect(){const[e]=document.getElementsByClassName("dp_secondary");e&&e.classList.remove("dp_secondary")}Deployable_SelectSecondary({classList:e}){if(e.contains("dp_primary")||e.contains("dp_secondary")||e.contains("dp_locked"))return;const[t]=document.getElementsByClassName("dp_secondary");t&&this.Deployable_Unselect(t),e.add("dp_secondary")}Deployable_Unlock({classList:e}){e.remove("dp_locked")}Deployable_Lock({classList:e}){e.add("dp_locked")}Deployable_DisplayDescriptionCard(t){const s=document.querySelector("#description_container, .dp_description"),r=this.builder.dbs.get("deployables").get(t),i=this.builder.lang.get("deployables."+t);let l=`<p class="description_title">${i.name}`;if(document.getElementById(t).parentElement.classList.contains("dp_locked"))for(const t of r.requires)l+='<br><span class="requires">'+e.resolveRequire(t.type,this.builder.lang.get(`${t.type}s.${t.name}.name`),this.builder.lang)+"</span>";l+=`</p><p>${i.description}</p>`.replace(/\n/g,"</p><p>").replace(/\t/g,"<br>"),s.innerHTML=l}IO_CopyLinkFlash(){let{classList:e}=document.getElementById("io_share_link");if(e.contains("io_link_flash"))return;e.add("io_link_flash");let t=document.getElementById("io_copy_btn"),s=t.innerText;t.innerText=this.builder.lang.get("system.share.copied"),setTimeout((()=>{e.remove("io_link_flash"),t.innerText=s}),500)}HandleJoat(e){const t=document.querySelector(".dp_selected, .dp_primary");t&&(t.classList.contains("dp_selected")&&!e?t.classList.replace("dp_selected","dp_primary"):t.classList.replace("dp_primary","dp_selected"))}HandleUnlocks(...e){const t=[];for(const{type:s,id:r,unlocks:i}of e)if(i)switch(s){case"skill":{const{state:e}=this.builder.exp.skills.get(r)||{state:0};for(const s of i)e<s.whenState&&t.push(s);break}default:this.builder.exp[s]!==r&&t.push(...i)}for(const{type:e,name:s}of t){const t=e.charAt(0).toUpperCase()+e.slice(1,e.length);if("deployable"===e)if(s){if(this.builder.exp[e]===s||this.builder.exp.deployableSecondary===s){if(this.Deployable_Unselect(document.getElementById(s).parentElement),this.builder.exp[e]!==s){this.builder.exp.deployableSecondary;continue}this.builder.exp[e]=null;const t=this.builder.exp.deployableSecondary;this.builder.exp.deployableSecondary=null,this.builder.exp[e]=t,this.DeployableSecondary_Unselect(),this.Deployable_Select(document.getElementById(t).parentElement)}}else{const t=document.querySelector(".dp_primary, .dp_selected");if(!t)continue;this.Deployable_Unselect(t),this.builder.exp[e]=null}else s?this.builder.exp[e]===s&&(this[t+"_Unselect"](),this.builder.exp[e]=null):(this[t+"_Unselect"](),this.builder.exp[e]=null)}return t}HandleRequirements(e){const t=this.builder.dbs.get(e);if(t)for(const[s,r]of t){if(!r.requires)continue;const t=document.getElementById(s).parentElement;for(const s of r.requires){const r=this.builder.exp[s.type.toCamelCase()+"s"]||this.builder.exp[s.type.toCamelCase()],i=e.charAt(0).toUpperCase()+e.slice(1,e.length-1);if(r instanceof Map){const e=r.get(s.name);e&&e.state>=s.state?this[`${i}_Unlock`](t):this[`${i}_Lock`](t)}else r===s.name?this[`${i}_Unlock`](t):this[`${i}_Lock`](t)}}}}s.COLOR_PATTERN=/(\+ ?|- ?|\b(?!OVE9000))[0-9]+([,.][0-9]+)?( point(s)?|%|cm)?/g;
